---

- name: configure docker listening ports
  lineinfile:
    dest=/etc/default/docker
    regexp=^#DOCKER_OPTS
    line="DOCKER_OPTS=\"{{ docker_opts }}\""
    backrefs=yes
  notify:
    - restart docker

- name: run swarm manager
  docker:
    name: swarm-manager
    image: swarm
    command: manage --advertise={{ member_address}} {{ consul_address }}
    state: reloaded
    restart_policy: on-failure
    ports:
      - "4000:2375"
  when: inventory_hostname_short == "swarm-1"

- name: run swarm member
  docker:
    name: swarm-member
    image: swarm
    command: join --advertise={{ member_address}} {{ consul_address }}
    state: reloaded
    restart_policy: on-failure
  when: inventory_hostname_short != "swarm-1"

- name: run registrator
  docker:
    name: registrator
    image: gliderlabs/registrator:latest
    command: "{{ consul_address }}"
    state: reloaded
    restart_policy: on-failure
    hostname: "{{ ansible_default_ipv4.address }}"
    volumes:
      - "/var/run/docker.sock:/tmp/docker.sock"